sudo: required
language: python
python: "3.7.5"

env:
    # TODO add more arango versions when they exist
    # TODO could split tests so non-arango tests aren't run for every version
    - ARANGODB_VER=3.5.0 ARANGODB_V=35

install:
  - python --version
  - which python
  - export ARANGO_FILE=arangodb3-linux-$ARANGODB_VER.tar.gz
  - wget https://download.arangodb.com/arangodb$ARANGODB_V/Community/Linux/$ARANGO_FILE
  - tar xfz $ARANGO_FILE
  - export ARANGO=`pwd`/arangodb3-$ARANGODB_VER/bin/arangodb
  - export ARANGOD=`pwd`/arangodb3-$ARANGODB_VER/usr/sbin/arangod

  # TODO move everything except pipenv to Pipfile dev section and change to make test
  - pip install pipenv coverage pytest-cov flake8
  - pipenv install
 
script:
# TODO change to make test
  - flake8 .
  - mkdir arangodata
  - $ARANGO start --server.arangod=$ARANGOD --starter.mode single --starter.data-dir ./arangodata
  - export PYTHONPATH=$(pwd):$(pwd)/src; pytest --verbose --cov=. .
  - $ARANGO stop

after_success:
  # codecov https://docs.codecov.com/docs/codecov-uploader#integrity-checking-the-uploader
  - curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
  - curl -Os https://uploader.codecov.io/latest/linux/codecov
  - curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM
  - curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM.sig
  - gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
  - shasum -a 256 -c codecov.SHA256SUM
  - chmod +x codecov
  - ./codecov
